name: Build StrongR Frida

on:
  workflow_dispatch:
    inputs:
      frida_version:
        description: 'Frida Version'
        required: true
        default: '17.5.2'

jobs:
  android_build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      actions: write

    steps:
    - uses: actions/checkout@v4
      with:
        path: 'patch_repo' # Senin forkladığın patch repusunu buraya çeker

    - uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: "temurin"
        java-version: "17"

    - name: Setup Android NDK
      id: setup-ndk
      uses: nttld/setup-ndk@v1.0.6
      with:
        ndk-version: r25b

    - name: Set up Python 3.9
      uses: actions/setup-python@v5.1.0
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        sudo apt-get update && DEBIAN_FRONTEND=noninteractive sudo apt-get install build-essential tree ninja-build gcc-multilib g++-multilib lib32stdc++-9-dev flex bison ruby ruby-dev python3-requests python3-setuptools python3-dev python3-pip libc6-dev libc6-dev-i386 -y
        sudo gem install fpm -v 1.11.0 --no-document
        python3 -m pip install lief graphlib

    - name: Clone and Patch Frida
      shell: bash
      run: |
        # Git Ayarları (Hata vermemesi için dummy ayarlar)
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        # Frida'yı İndir (Senin girdiğin versiyonu)
        echo "Cloning Frida ${{ inputs.frida_version }}..."
        git clone --recurse-submodules https://github.com/frida/frida
        cd frida
        git checkout ${{ inputs.frida_version }}
        git submodule update --recursive
        
        # PATCH UYGULAMA (En Kritik Kısım)
        # Yamalar 'patch_repo/Patchs/strongR-frida' altında
        echo "Applying StrongR Patches..."
        
        for path in ../patch_repo/Patchs/strongR-frida/*
        do
          name=$(basename $path)
          real=$(realpath $path)
          echo "Patching: $name"
          
          if [ -d "subprojects/$name" ]; then
            cd subprojects/$name
            git am $real/*.patch
            cd ../..
          else
             echo "Skipping $name (Not found in source)"
          fi
        done
        cd ..

    - name: Build Frida (Android ARM64)
      shell: bash
      run: |
        cd frida
        # Sadece ARM64 derliyoruz (Hız kazanmak için, senin telefon 64 bit)
        # Diğerlerini istersen aşağıya eklersin
        
        mkdir build-android-arm64
        cd build-android-arm64
        ../configure --host=android-arm64
        make
        
        # Server dosyasını sıkıştır
        echo "Packaging..."
        # Dosya yolu versiyonlara göre değişebilir, garanti olsun diye find kullanıyoruz
        find subprojects/frida-core/server -name "frida-server" -exec cp {} hluda-server \;
        gzip hluda-server

    - name: Upload Artifact (Download Here)
      uses: actions/upload-artifact@v4
      with:
        name: hluda-server-${{ inputs.frida_version }}-android-arm64
        path: frida/build-android-arm64/hluda-server.gz
